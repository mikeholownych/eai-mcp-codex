# Comprehensive System Health Alerting Rules
# Critical monitoring for overall system health, infrastructure, and resource utilization

groups:
  - name: node_health_alerts
    rules:
      # Node Availability
      - alert: NodeDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          service: system
          category: availability
        annotations:
          summary: "Node is down"
          description: "Node {{ $labels.instance }} is not responding to health checks"
          runbook_url: "https://docs.example.com/runbooks/node-down"
          
      - alert: NodeUnreachable
        expr: probe_success{job="blackbox"} == 0
        for: 2m
        labels:
          severity: critical
          service: system
          category: connectivity
        annotations:
          summary: "Node is unreachable"
          description: "Node {{ $labels.instance }} is unreachable from monitoring system"
          runbook_url: "https://docs.example.com/runbooks/node-unreachable"
      
      # CPU Utilization
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: system
          category: resources
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/high-cpu-usage"
          
      - alert: CriticalCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
        for: 2m
        labels:
          severity: critical
          service: system
          category: resources
        annotations:
          summary: "Critical CPU usage detected"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }} - system performance severely impacted"
          runbook_url: "https://docs.example.com/runbooks/critical-cpu-usage"
          
      - alert: HighCPULoad
        expr: node_load5 > (count by(instance) (node_cpu_seconds_total{mode="system"})) * 2
        for: 5m
        labels:
          severity: warning
          service: system
          category: resources
        annotations:
          summary: "High CPU load detected"
          description: "5-minute CPU load is {{ $value }} on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/high-cpu-load"
          
      - alert: CriticalCPULoad
        expr: node_load15 > (count by(instance) (node_cpu_seconds_total{mode="system"})) * 4
        for: 2m
        labels:
          severity: critical
          service: system
          category: resources
        annotations:
          summary: "Critical CPU load detected"
          description: "15-minute CPU load is {{ $value }} on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/critical-cpu-load"
      
      # Memory Utilization
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: system
          category: resources
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value }}% on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/high-memory-usage"
          
      - alert: CriticalMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 2m
        labels:
          severity: critical
          service: system
          category: resources
        annotations:
          summary: "Critical memory usage detected"
          description: "Memory usage is {{ $value }}% on {{ $labels.instance }} - system may run out of memory"
          runbook_url: "https://docs.example.com/runbooks/critical-memory-usage"
          
      - alert: HighSwapUsage
        expr: (1 - (node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes)) * 100 > 50
        for: 5m
        labels:
          severity: warning
          service: system
          category: resources
        annotations:
          summary: "High swap usage detected"
          description: "Swap usage is {{ $value }}% on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/high-swap-usage"
          
      - alert: CriticalSwapUsage
        expr: (1 - (node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes)) * 100 > 80
        for: 2m
        labels:
          severity: critical
          service: system
          category: resources
        annotations:
          summary: "Critical swap usage detected"
          description: "Swap usage is {{ $value }}% on {{ $labels.instance }} - system performance severely impacted"
          runbook_url: "https://docs.example.com/runbooks/critical-swap-usage"
      
      # Disk Utilization
      - alert: HighDiskUsage
        expr: (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|rootfs"} / node_filesystem_size_bytes{fstype!~"tmpfs|rootfs"})) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: system
          category: resources
        annotations:
          summary: "High disk usage detected"
          description: "Disk usage is {{ $value }}% on {{ $labels.instance }} {{ $labels.mountpoint }}"
          runbook_url: "https://docs.example.com/runbooks/high-disk-usage"
          
      - alert: CriticalDiskUsage
        expr: (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|rootfs"} / node_filesystem_size_bytes{fstype!~"tmpfs|rootfs"})) * 100 > 90
        for: 2m
        labels:
          severity: critical
          service: system
          category: resources
        annotations:
          summary: "Critical disk usage detected"
          description: "Disk usage is {{ $value }}% on {{ $labels.instance }} {{ $labels.mountpoint }} - system may run out of disk space"
          runbook_url: "https://docs.example.com/runbooks/critical-disk-usage"
          
      - alert: DiskInodesExhausted
        expr: (1 - (node_filesystem_files_free{fstype!~"tmpfs|rootfs"} / node_filesystem_files{fstype!~"tmpfs|rootfs"})) * 100 > 90
        for: 5m
        labels:
          severity: critical
          service: system
          category: resources
        annotations:
          summary: "Disk inodes exhausted"
          description: "Inode usage is {{ $value }}% on {{ $labels.instance }} {{ $labels.mountpoint }}"
          runbook_url: "https://docs.example.com/runbooks/disk-inodes-exhausted"
          
      - alert: DiskReadOnly
        expr: node_filesystem_readonly{fstype!~"tmpfs|rootfs"} == 1
        for: 0m
        labels:
          severity: critical
          service: system
          category: resources
        annotations:
          summary: "Filesystem is read-only"
          description: "Filesystem {{ $labels.mountpoint }} on {{ $labels.instance }} is mounted read-only"
          runbook_url: "https://docs.example.com/runbooks/disk-readonly"
      
      # Disk I/O
      - alert: HighDiskIO
        expr: rate(node_disk_io_time_seconds_total[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: system
          category: resources
        annotations:
          summary: "High disk I/O detected"
          description: "Disk I/O utilization is {{ $value }}% on {{ $labels.instance }} {{ $labels.device }}"
          runbook_url: "https://docs.example.com/runbooks/high-disk-io"
          
      - alert: CriticalDiskIO
        expr: rate(node_disk_io_time_seconds_total[5m]) * 100 > 95
        for: 2m
        labels:
          severity: critical
          service: system
          category: resources
        annotations:
          summary: "Critical disk I/O detected"
          description: "Disk I/O utilization is {{ $value }}% on {{ $labels.instance }} {{ $labels.device }}"
          runbook_url: "https://docs.example.com/runbooks/critical-disk-io"
      
      # Network
      - alert: HighNetworkTraffic
        expr: rate(node_network_receive_bytes_total[5m]) / 1024 / 1024 > 100
        for: 5m
        labels:
          severity: warning
          service: system
          category: network
        annotations:
          summary: "High network traffic detected"
          description: "Network receive rate is {{ $value }}MB/s on {{ $labels.instance }} {{ $labels.device }}"
          runbook_url: "https://docs.example.com/runbooks/high-network-traffic"
          
      - alert: NetworkInterfaceErrors
        expr: rate(node_network_receive_errs_total[5m]) + rate(node_network_transmit_errs_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: system
          category: network
        annotations:
          summary: "Network interface errors detected"
          description: "Network interface {{ $labels.device }} on {{ $labels.instance }} has {{ $value }} errors per second"
          runbook_url: "https://docs.example.com/runbooks/network-interface-errors"
          
      - alert: NetworkInterfaceDrops
        expr: rate(node_network_receive_drop_total[5m]) + rate(node_network_transmit_drop_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: system
          category: network
        annotations:
          summary: "Network interface drops detected"
          description: "Network interface {{ $labels.device }} on {{ $labels.instance }} has {{ $value }} packet drops per second"
          runbook_url: "https://docs.example.com/runbooks/network-interface-drops"
      
      # System Time
      - alert: SystemClockSkew
        expr: abs(node_timex_offset_seconds) > 2
        for: 5m
        labels:
          severity: warning
          service: system
          category: time
        annotations:
          summary: "System clock skew detected"
          description: "System clock on {{ $labels.instance }} is skewed by {{ $value }} seconds"
          runbook_url: "https://docs.example.com/runbooks/system-clock-skew"
          
      - alert: NTPSyncLost
        expr: node_timex_sync_status == 0
        for: 5m
        labels:
          severity: warning
          service: system
          category: time
        annotations:
          summary: "NTP synchronization lost"
          description: "NTP synchronization is lost on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/ntp-sync-lost"
      
      # Process Monitoring
      - alert: TooManyProcesses
        expr: node_procs_running > 1000
        for: 5m
        labels:
          severity: warning
          service: system
          category: processes
        annotations:
          summary: "Too many processes running"
          description: "{{ $value }} processes are running on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/too-many-processes"
          
      - alert: ProcessZombies
        expr: node_procs_zombies > 10
        for: 5m
        labels:
          severity: warning
          service: system
          category: processes
        annotations:
          summary: "Zombie processes detected"
          description: "{{ $value }} zombie processes on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/process-zombies"
          
      - alert: ProcessBlocked
        expr: node_procs_blocked > 100
        for: 5m
        labels:
          severity: warning
          service: system
          category: processes
        annotations:
          summary: "Blocked processes detected"
          description: "{{ $value }} blocked processes on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/process-blocked"

  - name: system_service_alerts
    rules:
      # SSH Service
      - alert: SSHServiceDown
        expr: node_systemd_unit_state{name="ssh.service", state="active"} == 0
        for: 1m
        labels:
          severity: critical
          service: system
          category: services
        annotations:
          summary: "SSH service is down"
          description: "SSH service is not active on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/ssh-service-down"
          
      - alert: SSHLoginFailures
        expr: rate(ssh_login_failures_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          service: system
          category: security
        annotations:
          summary: "SSH login failures detected"
          description: "{{ $value }} SSH login failures per minute on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/ssh-login-failures"
      
      # Docker Service
      - alert: DockerServiceDown
        expr: node_systemd_unit_state{name="docker.service", state="active"} == 0
        for: 1m
        labels:
          severity: critical
          service: system
          category: services
        annotations:
          summary: "Docker service is down"
          description: "Docker service is not active on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/docker-service-down"
          
      - alert: DockerDiskUsageHigh
        expr: (node_docker_data_used_bytes / node_docker_data_total_bytes) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: system
          category: resources
        annotations:
          summary: "Docker disk usage high"
          description: "Docker disk usage is {{ $value }}% on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/docker-disk-usage"
      
      # Systemd Services
      - alert: SystemdServiceFailed
        expr: node_systemd_unit_state{state="failed"} == 1
        for: 1m
        labels:
          severity: critical
          service: system
          category: services
        annotations:
          summary: "Systemd service failed"
          description: "Service {{ $labels.name }} has failed on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/systemd-service-failed"
          
      - alert: SystemdServiceRestarting
        expr: rate(node_systemd_unit_state{state="activating"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: system
          category: services
        annotations:
          summary: "Systemd service restarting frequently"
          description: "Service {{ $labels.name }} is restarting frequently on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/systemd-service-restarting"

  - name: system_security_alerts
    rules:
      # File System Security
      - alert: SuspiciousFileChanges
        expr: rate(node_filesystem_changes_total[5m]) > 100
        for: 5m
        labels:
          severity: warning
          service: system
          category: security
        annotations:
          summary: "Suspicious file system changes detected"
          description: "{{ $value }} file system changes per second on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/suspicious-file-changes"
          
      - alert: SUIDFilesDetected
        expr: node_filesystem_suid_files > 0
        for: 0m
        labels:
          severity: warning
          service: system
          category: security
        annotations:
          summary: "SUID files detected"
          description: "{{ $value }} SUID files found on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/suid-files-detected"
          
      - alert: WorldWritableFiles
        expr: node_filesystem_world_writable_files > 0
        for: 0m
        labels:
          severity: warning
          service: system
          category: security
        annotations:
          summary: "World writable files detected"
          description: "{{ $value }} world writable files found on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/world-writable-files"
      
      # User Security
      - alert: TooManyRootLogins
        expr: rate(user_logins_total{username="root"}[5m]) > 0
        for: 5m
        labels:
          severity: warning
          service: system
          category: security
        annotations:
          summary: "Too many root logins detected"
          description: "Root user logins detected on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/too-many-root-logins"
          
      - alert: SuspiciousUserActivity
        expr: rate(user_failed_logins_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: system
          category: security
        annotations:
          summary: "Suspicious user activity detected"
          description: "{{ $value }} failed login attempts per minute on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/suspicious-user-activity"
      
      # Network Security
      - alert: PortScanDetected
        expr: rate(network_connections_total[5m]) > 1000
        for: 5m
        labels:
          severity: warning
          service: system
          category: security
        annotations:
          summary: "Port scan detected"
          description: "{{ $value }} network connections per second on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/port-scan-detected"
          
      - alert: DDoSAttackDetected
        expr: rate(network_connections_total[5m]) > 5000
        for: 1m
        labels:
          severity: critical
          service: system
          category: security
        annotations:
          summary: "DDoS attack detected"
          description: "{{ $value }} network connections per second on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/ddos-attack-detected"

  - name: system_performance_alerts
    rules:
      # Context Switches
      - alert: HighContextSwitches
        expr: rate(node_context_switches_total[5m]) > 100000
        for: 5m
        labels:
          severity: warning
          service: system
          category: performance
        annotations:
          summary: "High context switches detected"
          description: "{{ $value }} context switches per second on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/high-context-switches"
          
      - alert: CriticalContextSwitches
        expr: rate(node_context_switches_total[5m]) > 500000
        for: 2m
        labels:
          severity: critical
          service: system
          category: performance
        annotations:
          summary: "Critical context switches detected"
          description: "{{ $value }} context switches per second on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/critical-context-switches"
      
      # Interrupts
      - alert: HighInterrupts
        expr: rate(node_interrupts_total[5m]) > 100000
        for: 5m
        labels:
          severity: warning
          service: system
          category: performance
        annotations:
          summary: "High interrupts detected"
          description: "{{ $value }} interrupts per second on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/high-interrupts"
          
      - alert: CriticalInterrupts
        expr: rate(node_interrupts_total[5m]) > 500000
        for: 2m
        labels:
          severity: critical
          service: system
          category: performance
        annotations:
          summary: "Critical interrupts detected"
          description: "{{ $value }} interrupts per second on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/critical-interrupts"
      
      # System Load
      - alert: HighSystemLoad
        expr: node_load1 > (count by(instance) (node_cpu_seconds_total{mode="system"})) * 1.5
        for: 5m
        labels:
          severity: warning
          service: system
          category: performance
        annotations:
          summary: "High system load detected"
          description: "1-minute load average is {{ $value }} on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/high-system-load"
          
      - alert: CriticalSystemLoad
        expr: node_load1 > (count by(instance) (node_cpu_seconds_total{mode="system"})) * 3
        for: 2m
        labels:
          severity: critical
          service: system
          category: performance
        annotations:
          summary: "Critical system load detected"
          description: "1-minute load average is {{ $value }} on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/critical-system-load"
      
      # Memory Pressure
      - alert: MemoryPressure
        expr: node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes < 0.1
        for: 5m
        labels:
          severity: warning
          service: system
          category: performance
        annotations:
          summary: "Memory pressure detected"
          description: "Available memory is {{ $value | humanizeBytes }} on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/memory-pressure"
          
      - alert: CriticalMemoryPressure
        expr: node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes < 0.05
        for: 2m
        labels:
          severity: critical
          service: system
          category: performance
        annotations:
          summary: "Critical memory pressure detected"
          description: "Available memory is {{ $value | humanizeBytes }} on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/critical-memory-pressure"

  - name: system_availability_alerts
    rules:
      # Uptime
      - alert: LowSystemUptime
        expr: time() - node_boot_time_seconds < 300
        for: 0m
        labels:
          severity: warning
          service: system
          category: availability
        annotations:
          summary: "System recently rebooted"
          description: "System {{ $labels.instance }} was rebooted {{ $value | humanizeDuration }} ago"
          runbook_url: "https://docs.example.com/runbooks/low-system-uptime"
          
      - alert: CriticalSystemUptime
        expr: time() - node_boot_time_seconds < 60
        for: 0m
        labels:
          severity: critical
          service: system
          category: availability
        annotations:
          summary: "System critically recently rebooted"
          description: "System {{ $labels.instance }} was rebooted {{ $value | humanizeDuration }} ago"
          runbook_url: "https://docs.example.com/runbooks/critical-system-uptime"
      
      # Process Availability
      - alert: CriticalProcessMissing
        expr: absent(node_procs{name=~"sshd|docker|nginx|postgres|redis"})
        for: 1m
        labels:
          severity: critical
          service: system
          category: availability
        annotations:
          summary: "Critical process missing"
          description: "Critical process {{ $labels.name }} is not running on {{ $labels.instance }}"
          runbook_url: "https://docs.example.com/runbooks/critical-process-missing"
      
      # Network Connectivity
      - alert: NetworkPartition
        expr: up{job="node-exporter"} == 0
        for: 2m
        labels:
          severity: critical
          service: system
          category: connectivity
        annotations:
          summary: "Network partition detected"
          description: "Node {{ $labels.instance }} is not reachable from monitoring system"
          runbook_url: "https://docs.example.com/runbooks/network-partition"
          
      - alert: HighLatency
        expr: probe_http_duration_seconds{job="blackbox"} > 2
        for: 2m
        labels:
          severity: warning
          service: system
          category: connectivity
        annotations:
          summary: "High network latency detected"
          description: "Network latency to {{ $labels.instance }} is {{ $value }}s"
          runbook_url: "https://docs.example.com/runbooks/high-latency"
          
      - alert: CriticalLatency
        expr: probe_http_duration_seconds{job="blackbox"} > 5
        for: 1m
        labels:
          severity: critical
          service: system
          category: connectivity
        annotations:
          summary: "Critical network latency detected"
          description: "Network latency to {{ $labels.instance }} is {{ $value }}s"
          runbook_url: "https://docs.example.com/runbooks/critical-latency"