# =====================================
# Production-Grade Fluentd Configuration
# For MCP Logging Pipeline (Fluentd v1.16+)
# =====================================

<system>
  log_level info
  workers 1
  root_dir /var/log/fluentd
  suppress_config_dump true
  enable_input_metrics true
  enable_size_metrics true
  <log>
    format json
    time_format %Y-%m-%dT%H:%M:%S.%LZ
  </log>
</system>

<ruby>
  require 'securerandom'
</ruby>

# === INPUT SOURCES ===

<source>
  @type forward
  @id forward_input
  port 24224
  bind 0.0.0.0
  tag mcp.*
  <security>
    self_hostname fluentd-server
    shared_key shared_secret_key
  </security>
</source>

<source>
  @type tail
  path /app/logs/*.log
  pos_file /var/log/fluentd/app.pos
  tag mcp.app
  format json
  read_from_head true
</source>

# === FILTERS ===

<filter mcp.**>
  @type record_transformer
  enable_ruby true
  <record>
    trace_id ${record["trace_id"] || SecureRandom.uuid}
    span_id ${record["span_id"] || SecureRandom.uuid[0..15]}
    log_level ${record["level"] || "info"}
    processed_at ${time}
  </record>
</filter>

<filter mcp.security>
  @type record_transformer
  enable_ruby true
  <record>
    threat_tags ${(record["message"] || '').scan(/sql|xss|csrf|unauthorized/i).uniq.join(',')}
  </record>
</filter>

<filter mcp.audit>
  @type record_transformer
  enable_ruby true
  <record>
    audit_status ${record["status"] || "unknown"}
  </record>
</filter>

# === OUTPUTS ===

<match mcp.error>
  @type copy
  <store>
    @type file
    path /var/log/fluentd/error
    append true
    compress gzip
    <buffer>
      flush_interval 5s
      path /var/log/fluentd/buffer/error
    </buffer>
  </store>
</match>

<match mcp.app>
  @type file
  path /var/log/fluentd/app
  append true
  compress gzip
  <buffer>
    flush_interval 10s
    path /var/log/fluentd/buffer/app
  </buffer>
</match>

<match mcp.audit>
  @type file
  path /var/log/fluentd/audit
  append true
  compress gzip
  <buffer>
    flush_interval 15s
    path /var/log/fluentd/buffer/audit
  </buffer>
</match>

<match mcp.security>
  @type file
  path /var/log/fluentd/security
  append true
  compress gzip
  <buffer>
    flush_interval 20s
    path /var/log/fluentd/buffer/security
  </buffer>
</match>

<match mcp.**>
  @type stdout
</match>
