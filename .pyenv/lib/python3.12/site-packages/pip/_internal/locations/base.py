import functools
import os
import site
import sys
import sysconfig
import typing

from pip._internal.exceptions import InstallationError
from pip._internal.utils import appdirs
from pip._internal.utils.virtualenv import running_under_virtualenv

# Application Directories
USER_CACHE_DIR = appdirs.user_cache_dir("pip")

# FIXME doesn't account for venv linked to global site-packages
site_packages: str = sysconfig.get_path("purelib")


def get_major_minor_version() -> str:
    """
    Return the major-minor version of the current Python as a string, e.g.
    "3.7" or "3.10".
    """
    return "{}.{}".format(*sys.version_info)


def change_root(new_root: str, pathname: str) -> str:
    """
    Return `pathname` with `new_root` prepended in a platform-aware way.
    
    On POSIX:
    - If `pathname` is relative, returns os.path.join(new_root, pathname).
    - If `pathname` is absolute, strips the leading '/' and joins the remainder to `new_root`.
    
    On Windows (nt):
    - Splits off any drive letter, removes a leading backslash from the remaining path if present, and joins that path to `new_root`.
    
    Parameters:
        new_root (str): Root path to prepend.
        pathname (str): Path to be made relative to `new_root` before joining.
    
    Returns:
        str: The combined path with `new_root` as its prefix.
    
    Raises:
        InstallationError: If running on an unsupported platform (os.name not 'posix' or 'nt').
    """
    if os.name == "posix":
        if not os.path.isabs(pathname):
            return os.path.join(new_root, pathname)
        else:
            return os.path.join(new_root, pathname[1:])

    elif os.name == "nt":
        (drive, path) = os.path.splitdrive(pathname)
        if path[0] == "\\":
            path = path[1:]
        return os.path.join(new_root, path)

    else:
        raise InstallationError(
            f"Unknown platform: {os.name}\n"
            "Can not change root path prefix on unknown platform."
        )


def get_src_prefix() -> str:
    """
    Return the absolute path to the "src" directory to use for building/installing packages.
    
    If running inside a virtualenv, the directory is taken as "<sys.prefix>/src".
    Otherwise, it is "<current working directory>/src". If the current working directory
    cannot be determined (OSError), the process exits with an error message.
    
    Returns:
        str: Absolute path to the chosen "src" directory.
    """
    if running_under_virtualenv():
        src_prefix = os.path.join(sys.prefix, "src")
    else:
        # FIXME: keep src in cwd for now (it is not a temporary folder)
        try:
            src_prefix = os.path.join(os.getcwd(), "src")
        except OSError:
            # In case the current working directory has been renamed or deleted
            sys.exit("The folder you are executing pip from can no longer be found.")

    # under macOS + virtualenv sys.prefix is not properly resolved
    # it is something like /path/to/python/bin/..
    return os.path.abspath(src_prefix)


try:
    # Use getusersitepackages if this is present, as it ensures that the
    # value is initialised properly.
    user_site: typing.Optional[str] = site.getusersitepackages()
except AttributeError:
    user_site = site.USER_SITE


@functools.lru_cache(maxsize=None)
def is_osx_framework() -> bool:
    """
    Return True if the running Python was built as a macOS (OS X) framework.
    
    Checks the `PYTHONFRAMEWORK` configuration variable from sysconfig; returns True when that variable is set (framework build), and False otherwise.
    """
    return bool(sysconfig.get_config_var("PYTHONFRAMEWORK"))
