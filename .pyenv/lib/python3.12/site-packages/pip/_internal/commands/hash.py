import hashlib
import logging
import sys
from optparse import Values
from typing import List

from pip._internal.cli.base_command import Command
from pip._internal.cli.status_codes import ERROR, SUCCESS
from pip._internal.utils.hashes import FAVORITE_HASH, STRONG_HASHES
from pip._internal.utils.misc import read_chunks, write_output

logger = logging.getLogger(__name__)


class HashCommand(Command):
    """
    Compute a hash of a local package archive.

    These can be used with --hash in a requirements file to do repeatable
    installs.
    """

    usage = "%prog [options] <file> ..."
    ignore_require_venv = True

    def add_options(self) -> None:
        """
        Register command-line options for the HashCommand.
        
        Adds the `-a/--algorithm` option (choices: STRONG_HASHES, default: FAVORITE_HASH)
        and inserts the option group into the command parser so the command accepts a
        hash algorithm selection when invoked.
        """
        self.cmd_opts.add_option(
            "-a",
            "--algorithm",
            dest="algorithm",
            choices=STRONG_HASHES,
            action="store",
            default=FAVORITE_HASH,
            help="The hash algorithm to use: one of {}".format(
                ", ".join(STRONG_HASHES)
            ),
        )
        self.parser.insert_option_group(0, self.cmd_opts)

    def run(self, options: Values, args: List[str]) -> int:
        """
        Compute and print hashes for the given local archive files using the selected algorithm.
        
        For each file path in `args`, writes two lines of output:
            <path>:
            --hash=<algorithm>:<hex-digest>
        
        If `args` is empty, prints the command usage to stderr and returns ERROR.
        
        Parameters:
            options (Values): Parsed command options; expects `options.algorithm` to be the hash algorithm name.
            args (List[str]): File paths to hash.
        
        Returns:
            int: SUCCESS (all files processed) or ERROR (no files provided).
        """
        if not args:
            self.parser.print_usage(sys.stderr)
            return ERROR

        algorithm = options.algorithm
        for path in args:
            write_output(
                "%s:\n--hash=%s:%s", path, algorithm, _hash_of_file(path, algorithm)
            )
        return SUCCESS


def _hash_of_file(path: str, algorithm: str) -> str:
    """
    Compute and return the hexadecimal hash digest of a file using the specified algorithm.
    
    Reads the file at `path` in binary mode and updates the hashlib algorithm incrementally
    using chunks (via read_chunks), so large files are streamed rather than loaded into memory.
    
    Parameters:
        path (str): Filesystem path to the file to hash.
        algorithm (str): Name of the hash algorithm supported by hashlib (e.g., "sha256").
    
    Returns:
        str: Hexadecimal digest string for the file using the given algorithm.
    """
    with open(path, "rb") as archive:
        hash = hashlib.new(algorithm)
        for chunk in read_chunks(archive):
            hash.update(chunk)
    return hash.hexdigest()
